From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Yannick Lamprecht <yannicklamprecht@live.de>
Date: Sat, 16 Mar 2024 22:58:19 +0100
Subject: [PATCH] add disguise api


diff --git a/src/main/java/com/destroystokyo/paper/PaperSkinParts.java b/src/main/java/com/destroystokyo/paper/PaperSkinParts.java
index b6f4400df3d8ec7e06a996de54f8cabba57885e1..ce28a4e9597b8c7a2d535eaac34d8babd67ed226 100644
--- a/src/main/java/com/destroystokyo/paper/PaperSkinParts.java
+++ b/src/main/java/com/destroystokyo/paper/PaperSkinParts.java
@@ -71,4 +71,59 @@ public class PaperSkinParts implements SkinParts {
             .add("hats=" + hasHatsEnabled())
             .toString();
     }
+
+    public static SkinParts.Builder builder(){
+        return new Builder();
+    }
+
+    public static class Builder implements SkinParts.Builder{
+        private int raw = 0;
+
+        private static final int CAPE = 0x01;
+        private static final int JACKET = 0x02;
+        private static final int LEFT_SLEEVE = 0x04;
+        private static final int RIGHT_SLEEVE = 0x08;
+        private static final int LEFT_PANTS = 0x10;
+        private static final int RIGHT_PANTS = 0x20;
+        private static final int HAT = 0x40;
+
+        public @org.jetbrains.annotations.NotNull Builder withCape(){
+            raw |= CAPE;
+            return this;
+        }
+
+        public @org.jetbrains.annotations.NotNull Builder withJacket(){
+            raw |= JACKET;
+            return this;
+        }
+
+        public @org.jetbrains.annotations.NotNull Builder withLeftSleeve(){
+            raw |= LEFT_SLEEVE;
+            return this;
+        }
+
+        public @org.jetbrains.annotations.NotNull Builder withRightSleeve(){
+            raw |= RIGHT_SLEEVE;
+            return this;
+        }
+
+        public @org.jetbrains.annotations.NotNull Builder withLeftPants(){
+            raw |= LEFT_PANTS;
+            return this;
+        }
+
+        public @org.jetbrains.annotations.NotNull Builder withRightPants(){
+            raw |= RIGHT_PANTS;
+            return this;
+        }
+
+        public @org.jetbrains.annotations.NotNull Builder withHat(){
+            raw |= HAT;
+            return this;
+        }
+
+        public @org.jetbrains.annotations.NotNull SkinParts build(){
+            return new PaperSkinParts(raw);
+        }
+    }
 }
diff --git a/src/main/java/io/papermc/paper/disguise/DisguiseUtil.java b/src/main/java/io/papermc/paper/disguise/DisguiseUtil.java
new file mode 100644
index 0000000000000000000000000000000000000000..30b770ff2990a298cb19efcd82eef2266e68e85d
--- /dev/null
+++ b/src/main/java/io/papermc/paper/disguise/DisguiseUtil.java
@@ -0,0 +1,92 @@
+package io.papermc.paper.disguise;
+
+import com.destroystokyo.paper.profile.PlayerProfile;
+import java.util.EnumSet;
+import java.util.List;
+import net.minecraft.network.protocol.game.ClientboundAddEntityPacket;
+import net.minecraft.network.protocol.game.ClientboundPlayerInfoUpdatePacket;
+import net.minecraft.network.syncher.EntityDataAccessor;
+import net.minecraft.network.syncher.SynchedEntityData;
+import net.minecraft.server.level.ServerPlayer;
+import net.minecraft.world.entity.Entity;
+import net.minecraft.world.entity.player.Player;
+import net.minecraft.world.phys.Vec3;
+import org.bukkit.Bukkit;
+
+public final class DisguiseUtil {
+    private DisguiseUtil(){}
+
+    public static boolean tryDisguise(ServerPlayer player, Entity entity, ClientboundAddEntityPacket clientboundAddEntityPacket) {
+            return switch (entity.getBukkitEntity().getDisguiseData()) {
+                case DisguiseData.OriginalDisguise disguise -> false;
+                case io.papermc.paper.disguise.EntityTypeDisguise(var type) -> {
+                    player.connection.send(new net.minecraft.network.protocol.game.ClientboundAddEntityPacket(
+                        clientboundAddEntityPacket.getId(),
+                        clientboundAddEntityPacket.getUUID(),
+                        clientboundAddEntityPacket.getX(),
+                        clientboundAddEntityPacket.getY(),
+                        clientboundAddEntityPacket.getZ(),
+                        clientboundAddEntityPacket.getXRot(),
+                        clientboundAddEntityPacket.getYRot(),
+                        org.bukkit.craftbukkit.entity.CraftEntityType.bukkitToMinecraft(type),
+                        0,
+                        Vec3.ZERO.add(clientboundAddEntityPacket.getX(), clientboundAddEntityPacket.getY(), clientboundAddEntityPacket.getZ()).scale(1/8000.0D),
+                        clientboundAddEntityPacket.getYHeadRot()
+                    ));
+
+                    yield  true;
+                }
+                case io.papermc.paper.disguise.PlayerDisguise(var playerProfile, var listed, var skinParts) -> {
+                    PlayerProfile adapted = Bukkit.createProfile(entity.getUUID(), entity.hasCustomName()? entity.getBukkitEntity().getCustomName(): playerProfile.getName());
+                    adapted.setProperties(playerProfile.getProperties());
+                    net.minecraft.network.protocol.game.ClientboundPlayerInfoUpdatePacket.Entry playerUpdate =
+                        new net.minecraft.network.protocol.game.ClientboundPlayerInfoUpdatePacket.Entry(
+                            entity.getUUID(),
+                            com.destroystokyo.paper.profile.CraftPlayerProfile.asAuthlibCopy(adapted),
+                            listed,
+                            0,
+                            net.minecraft.world.level.GameType.DEFAULT_MODE,
+                            entity.getCustomName(),
+                            null
+                        );
+                    player.connection.send(new net.minecraft.network.protocol.game.ClientboundPlayerInfoUpdatePacket(EnumSet.of(net.minecraft.network.protocol.game.ClientboundPlayerInfoUpdatePacket.Action.ADD_PLAYER), playerUpdate));
+                    player.connection.send(new net.minecraft.network.protocol.game.ClientboundPlayerInfoUpdatePacket(EnumSet.of(ClientboundPlayerInfoUpdatePacket.Action.UPDATE_LISTED), playerUpdate));
+
+                    player.connection.send(new net.minecraft.network.protocol.game.ClientboundAddEntityPacket(
+                        clientboundAddEntityPacket.getId(),
+                        clientboundAddEntityPacket.getUUID(),
+                        clientboundAddEntityPacket.getX(),
+                        clientboundAddEntityPacket.getY(),
+                        clientboundAddEntityPacket.getZ(),
+                        clientboundAddEntityPacket.getXRot(),
+                        clientboundAddEntityPacket.getYRot(),
+                        net.minecraft.world.entity.EntityType.PLAYER,
+                        0,
+                        Vec3.ZERO.add(clientboundAddEntityPacket.getX(), clientboundAddEntityPacket.getY(), clientboundAddEntityPacket.getZ()).scale(1/8000.0D),
+                        clientboundAddEntityPacket.getYHeadRot()
+                    ));
+                    if(skinParts != null) {
+                        player.connection.send(new net.minecraft.network.protocol.game.ClientboundSetEntityDataPacket(
+                            clientboundAddEntityPacket.getId(),
+                            List.of(new SynchedEntityData.DataItem<>(Player.DATA_PLAYER_MODE_CUSTOMISATION, (byte) skinParts.getRaw()).value())
+                        ));
+                    }
+                    yield  true;
+                }
+            };
+        }
+
+    public static boolean shouldSkip(Entity entity, EntityDataAccessor<?> dataAccessor) {
+        return switch (entity.getBukkitEntity().getDisguiseData()) {
+            case DisguiseData.OriginalDisguise original -> false;
+            case EntityTypeDisguise entityTypeDisguise -> !io.papermc.paper.entity.meta.EntityMetaWatcher.isValidForClass(
+                org.bukkit.craftbukkit.entity.CraftEntityType.bukkitToMinecraft(entityTypeDisguise.entityType()).getBaseClass(),
+                dataAccessor
+            );
+            case PlayerDisguise playerDisguise -> !io.papermc.paper.entity.meta.EntityMetaWatcher.isValidForClass(
+                ServerPlayer.class,
+                dataAccessor
+            );
+        };
+    }
+}
diff --git a/src/main/java/net/minecraft/network/syncher/SynchedEntityData.java b/src/main/java/net/minecraft/network/syncher/SynchedEntityData.java
index 0f99733660f91280e4c6262cf75b3c9cae86f65a..2bb940208c2a0842962d070ef407cbf79e48c21c 100644
--- a/src/main/java/net/minecraft/network/syncher/SynchedEntityData.java
+++ b/src/main/java/net/minecraft/network/syncher/SynchedEntityData.java
@@ -100,6 +100,7 @@ public class SynchedEntityData {
 
                 if (datawatcher_item.isDirty()) {
                     datawatcher_item.setDirty(false);
+                    if (io.papermc.paper.disguise.DisguiseUtil.shouldSkip((net.minecraft.world.entity.Entity) entity, datawatcher_item.getAccessor())) continue; // Paper - disguise api
                     list.add(datawatcher_item.value());
                 }
             }
@@ -116,7 +117,7 @@ public class SynchedEntityData {
 
         for (int j = 0; j < i; ++j) {
             SynchedEntityData.DataItem<?> datawatcher_item = adatawatcher_item[j];
-
+            if (io.papermc.paper.disguise.DisguiseUtil.shouldSkip((net.minecraft.world.entity.Entity) entity, datawatcher_item.getAccessor())) continue; // Paper - disguise api
             if (!datawatcher_item.isSetToDefault()) {
                 if (list == null) {
                     list = new ArrayList();
@@ -135,7 +136,7 @@ public class SynchedEntityData {
         while (iterator.hasNext()) {
             SynchedEntityData.DataValue<?> datawatcher_c = (SynchedEntityData.DataValue) iterator.next();
             SynchedEntityData.DataItem<?> datawatcher_item = this.itemsById[datawatcher_c.id];
-
+            if (io.papermc.paper.disguise.DisguiseUtil.shouldSkip((net.minecraft.world.entity.Entity) entity, datawatcher_item.getAccessor())) continue; // Paper - disguise api
             this.assignValue(datawatcher_item, datawatcher_c);
             this.entity.onSyncedDataUpdated(datawatcher_item.getAccessor());
         }
@@ -158,6 +159,7 @@ public class SynchedEntityData {
     public List<SynchedEntityData.DataValue<?>> packAll() {
         final List<SynchedEntityData.DataValue<?>> list = new ArrayList<>();
         for (final DataItem<?> dataItem : this.itemsById) {
+            if (io.papermc.paper.disguise.DisguiseUtil.shouldSkip((net.minecraft.world.entity.Entity) entity, dataItem.getAccessor())) continue; // Paper - disguise api
             list.add(dataItem.value());
         }
 
diff --git a/src/main/java/net/minecraft/server/level/ServerEntity.java b/src/main/java/net/minecraft/server/level/ServerEntity.java
index 4f103f731623a8570238a6867fda1c5f83fca4e4..98459a018ae5f70c09c0026c23b245d4e6d06a6b 100644
--- a/src/main/java/net/minecraft/server/level/ServerEntity.java
+++ b/src/main/java/net/minecraft/server/level/ServerEntity.java
@@ -308,7 +308,11 @@ public class ServerEntity {
         Packet<ClientGamePacketListener> packet = this.entity.getAddEntityPacket();
 
         this.yHeadRotp = Mth.floor(this.entity.getYHeadRot() * 256.0F / 360.0F);
-        sender.accept(packet);
+        // Paper start - disguise api
+        if(!io.papermc.paper.disguise.DisguiseUtil.tryDisguise(player, entity, (net.minecraft.network.protocol.game.ClientboundAddEntityPacket) packet)){
+            sender.accept(packet);
+        }
+        // Paper end - disguise api
         if (this.trackedDataValues != null) {
             sender.accept(new ClientboundSetEntityDataPacket(this.entity.getId(), this.trackedDataValues));
         }
diff --git a/src/main/java/org/bukkit/craftbukkit/CraftServer.java b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
index 05e304f9fc8d0291fa779da589bd060ef4165b49..a12e83c4e7ce3a4f7440ee0f51cb5ef990203714 100644
--- a/src/main/java/org/bukkit/craftbukkit/CraftServer.java
+++ b/src/main/java/org/bukkit/craftbukkit/CraftServer.java
@@ -379,6 +379,12 @@ public final class CraftServer implements Server {
         return io.papermc.paper.util.TickThread.isTickThreadFor(((org.bukkit.craftbukkit.entity.CraftEntity) entity).getHandleRaw());
     }
     // Paper end - Folia reagion threading API
+    // Paper start - add disguise api
+    @Override
+    public com.destroystokyo.paper.SkinParts.@org.jetbrains.annotations.NotNull Builder newSkinPartsBuilder() {
+        return com.destroystokyo.paper.PaperSkinParts.builder();
+    }
+    // Paper end - add disguise api
 
     static {
         ConfigurationSerialization.registerClass(CraftOfflinePlayer.class);
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
index a2d336ceb52b63db5c03432ee7bc94dc6a742b82..18428b5ebccdbc7f07155c57bf24392a6bbc6e48 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
@@ -1280,4 +1280,16 @@ public abstract class CraftEntity implements org.bukkit.entity.Entity {
         return this.getHandle().getScoreboardName();
     }
     // Paper end - entity scoreboard name
+    // Paper start - disguise api
+    private io.papermc.paper.disguise.DisguiseData disguiseData = io.papermc.paper.disguise.DisguiseData.original();
+    @Override
+    public @org.jetbrains.annotations.NotNull io.papermc.paper.disguise.DisguiseData getDisguiseData() {
+        return disguiseData;
+    }
+
+    @Override
+    public void setDisuiseData(@org.jetbrains.annotations.NotNull io.papermc.paper.disguise.DisguiseData disguiseData) {
+        this.disguiseData = disguiseData;
+    }
+    // Paper end - disguise api
 }
